<!doctype html>
<html lang="en">
  <head>
    <title>pwd</title>
    <script>
const files = { };

window.onload = () => {
  const encoder = new TextEncoder();
  const decoder = new TextDecoder();

  const salted = { text : 'Salted__', bytes : encoder.encode('Salted__'), length : 8 };

  const elements = {
    pwd : document.getElementById('pwd'),
    files : document.getElementById('files'),
    file : document.getElementById('file')
  };

  for (const key of Object.keys(files).sort()) {
    const item = document.createElement('li');
    const link = item.appendChild(document.createElement('a'));
    link.appendChild(document.createTextNode(key));
    link.setAttribute('href', '#');
    link.onclick = e => {
      e.preventDefault();
      clear(elements.file);
      decrypt(files[key], elements.pwd.value).then((value, err) =>
        file.appendChild(document.createTextNode(err || value)));
    };
    elements.files.appendChild(item);
  }

  function clear(element) {
    while (element.firstChild)
      element.removeChild(element.firstChild);
  }

  function stringToBytes(value) {
    const array = new Uint8Array(value.length >> 1);
    for (let i = 0, j = 0; i < value.length; i += 2, j++)
      array[j] = parseInt(value.substr(i, 2), 16);
    return array;
  }
  
  function bytesToString(value) {
    const bytes = new Uint8Array(value);
    const pairs = new Array(bytes.byteLength * 2);
    for (let i = 0, j = 0; i < value.byteLength; i++, j += 2) {
      const byte = bytes[i];
      pairs[j] = (byte >>> 4).toString(16);
      pairs[j + 1] = (byte & 0xF).toString(16);
    }
    return pairs.join('');
  }
  

  async function deriveKeyAndIv(salt, pwd) {
    const baseKey = await crypto.subtle.importKey('raw', encoder.encode(pwd), 'PBKDF2', false, [ 'deriveBits' ]);
    const bits = await crypto.subtle.deriveBits({ name : 'PBKDF2', hash : 'SHA-256', salt : salt, iterations : 10000 }, baseKey, 384);
    const key = await crypto.subtle.importKey('raw', bits.slice(0, 32), { name : 'AES-CBC' }, false, [ 'encrypt', 'decrypt' ]);
    const iv = bits.slice(32, 48);
    return { key, iv };
  }

  async function encrypt(data, pwd) {
    const salt = new Uint8Array(8);
    crypto.getRandomValues(salt);
    const { key, iv } = await deriveKeyAndIv(salt, pwd);
    const encrypted = await crypto.subtle.encrypt({ name : 'AES-CBC', iv }, key, encoder.encode(data));
    const content = new Uint8Array([...salted.bytes, ...salt, ...new Uint8Array(encrypted)]);
    return bytesToString(content);
  }

  async function decrypt(data, pwd) {
    const bytes = stringToBytes(data);
    const salt = bytes.slice(salted.length, salted.length + 8);
    const { key, iv } = await deriveKeyAndIv(salt, pwd);
    const decrypted = await crypto.subtle.decrypt({ name : 'AES-CBC', iv }, key, bytes.slice(salted.length + 8));
    return decoder.decode(decrypted);
  }
};
    </script>
  </head>
  <body>
    <div>
      <label for="pwd">Password:</label>
      <input id="pwd" type="password">
    </div>
    <table>
      <tr>
        <td valign="top">
          <ul id="files"></ul>
        </td>
        <td valign="top">
          <div>
            <pre id="file"></pre>
          </div>
        </td>
      </tr>
    </table>
  </body>
</html>